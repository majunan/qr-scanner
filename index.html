<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å±¤æ¶ç‹€æ…‹è¨˜éŒ„ï¼ˆçœŸç«™/æ¨¹æ—ï¼‰</title>
  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    /* ...ï¼ˆåŸæœ¬ä½ çš„ CSS å¯ä¿ç•™ï¼‰... */
  </style>
</head>
<body>
  <h1>ğŸ“‹ å±¤æ¶ç‹€æ…‹è¨˜éŒ„</h1>
  <button id="googleLoginBtn">Google ç™»å…¥</button>
  <button id="soundBtn">ğŸ”‡ éŸ³æ•ˆé—œé–‰</button>
  <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
  <!-- ...ï¼ˆåŸæœ¬ä½ çš„ HTML å…ƒç´ å¯ä¿ç•™ï¼‰... -->

  <!-- ...ä½ çš„æƒæå™¨/è¨˜éŒ„/æ‹ç…§ç­‰çµæ§‹ä¸è®Š... -->

  <script>
    // ===== Google Sheets API è¨­å®š =====
    const CLIENT_ID = '558874309133-2ov80lnnm24h711hppoi51t7rpf36jiu.apps.googleusercontent.com';
    const API_KEY = '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';
    const SPREADSHEET_ID = '1SpLED6p_23s0B7RgNvxTmJJL7d1LuNVhrQXXY7MYFI0';
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    // ===== Google API åˆå§‹åŒ– =====
    let isGoogleAuthed = false;
    document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);

    function initGoogleClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        // å¯é¸ï¼šé¡¯ç¤ºç™»å…¥ç‹€æ…‹
        isGoogleAuthed = gapi.auth2.getAuthInstance().isSignedIn.get();
        updateGoogleLoginBtn();
        gapi.auth2.getAuthInstance().isSignedIn.listen(function(status){
          isGoogleAuthed = status;
          updateGoogleLoginBtn();
        });
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      gapi.load('client:auth2', initGoogleClient);
    });

    function handleGoogleLogin() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        isGoogleAuthed = true;
        updateGoogleLoginBtn();
        alert('Google ç™»å…¥æˆåŠŸï¼');
      });
    }
    function updateGoogleLoginBtn() {
      document.getElementById('googleLoginBtn').textContent = isGoogleAuthed ? 'å·²ç™»å…¥' : 'Google ç™»å…¥';
      document.getElementById('googleLoginBtn').disabled = isGoogleAuthed;
    }

    // ===== å¯«å…¥æƒæç´€éŒ„åˆ° Google Sheets =====
    function appendToSheet(data, time, status, remark) {
      if (!isGoogleAuthed) {
        alert("è«‹å…ˆ Google ç™»å…¥å†å¯«å…¥ Google Sheetsï¼");
        return;
      }
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: "å·¥ä½œè¡¨1!A1", // è«‹ä¾ä½ çš„å·¥ä½œè¡¨åç¨±èª¿æ•´
        valueInputOption: "RAW",
        insertDataOption: "INSERT_ROWS",
        resource: { values: [[data, time, status, remark]] }
      }).then(response => {
        console.log('å¯«å…¥ Google Sheets æˆåŠŸ:', response);
      }, error => {
        alert('å¯«å…¥ Google Sheets å¤±æ•—: ' + error.result.error.message);
      });
    }

    // ===== æ”¹å¯« addHistory è®“æƒæç´€éŒ„ä¹Ÿå¯«å…¥ Sheet =====
    function addHistory(data) {
      const now = new Date().toISOString();
      appendToSheet(data, formatTime(now), "è£œè²¨", "");
      playBeep(); // å¦‚æœä½ æœ‰éŸ³æ•ˆ
    }

    // ===== å…¶ä»– JS åŠŸèƒ½ï¼ˆåŸæœ¬ä½ çš„æƒæã€æ‹ç…§ç­‰ JS å¯ç¹¼çºŒä½¿ç”¨ï¼‰ =====
    // ...ï¼ˆåŸæœ¬ä½ çš„ JS å¯ä¿ç•™ï¼‰...

    // ===== formatTime å·¥å…·å‡½æ•¸ï¼ˆä½ çš„åŸæœ¬ç¨‹å¼å·²æœ‰ï¼‰ =====
    function formatTime(isoString) {
      const date = new Date(isoString);
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }
  </script>
</body>
</html>