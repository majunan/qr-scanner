<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å±¤æ¶ç‹€æ…‹è¨˜éŒ„ (æ”¯æ´æ¢ç¢¼å‚™è¨»)</title>
  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1, h2 { margin-top: 20px; }
    button { 
      margin: 5px; 
      padding: 6px 12px; 
      font-size: 1em; 
      cursor: pointer; 
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #reader { 
      width: 300px; 
      height: 300px; 
      margin: 0 auto; 
      border: 2px solid #333; 
      display: block;
    }
    .record {
      border-left: 6px solid #ccc;  /* é è¨­å·¦å´ç·šæ¢ */
      border-bottom: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9; /* é è¨­èƒŒæ™¯ */
    }
    .record[data-status="restock"] {
      border-left-color: orange;
    }
    .record[data-status="empty"] {
      border-left-color: #b7f5b7;  /* ç©ºä½å·¦å´ç·šæ¢è˜‹æœç¶  */
      /* èƒŒæ™¯ä¿æŒé è¨­ä¸è®Š */
      background-color: #f9f9f9;
    }
    .options { margin-top: 8px; }
    .notes {
      font-size: 0.8em;
      color: blue; /* å‚™è¨»å­—é«”è—è‰² */
      margin-top: 8px;
      padding: 5px;
      background-color: #eef;
      border-radius: 3px;
    }
    #noteScanModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #noteScanPreview {
      width: 80%;
      max-width: 500px;
      height: 300px;
      object-fit: cover;
    }
    #noteScanCancel {
      margin-top: 20px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #statusStats {
      margin-left: 20px;  /* æ–°å¢é€™è¡Œè®“çµ±è¨ˆæ•¸å­—å‘å³ç§»å‹• */
      border-bottom: 3px double #333; /* Added double line */
      padding-bottom: 10px; /* Add some space below the line */
      margin-bottom: 20px; /* Add space between line and next content */
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ å±¤æ¶ç‹€æ…‹è¨˜éŒ„</h1>
  <button id="soundBtn">ğŸ”‡ éŸ³æ•ˆé—œé–‰</button>
  <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>

  <video id="reader"></video> 
  
  <h2>ğŸ“· æƒæè¨˜éŒ„</h2>
  <select id="statusFilter">
    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
    <option value="restock">è£œè²¨</option>
    <option value="empty">ç©ºä½</option>
  </select>
  
  <div id="statusStats"></div>
  <div id="resultList"></div>
  
  <div id="noteScanModal">
    <video id="noteScanPreview"></video>
    <button id="noteScanCancel">å–æ¶ˆå‚™è¨»æƒæ</button>
  </div>

  <script>
    const STORAGE_KEY = "shelf-scan-history";
    const SOUND_KEY = "sound-enabled";
    const resultList = document.getElementById("resultList");
    const statusFilter = document.getElementById("statusFilter");
    const statusStats = document.getElementById("statusStats");
    const exportBtn = document.getElementById("exportBtn");
    const soundBtn = document.getElementById("soundBtn");
    const noteScanModal = document.getElementById("noteScanModal");
    const noteScanPreview = document.getElementById("noteScanPreview");
    const noteScanCancel = document.getElementById("noteScanCancel");

    let currentScanner = null;
    let currentNoteTarget = null;
    let soundEnabled = false;
    let lastScanTimeMap = {}; 

    document.addEventListener('DOMContentLoaded', function() {
      initSound();
      loadHistory();
      startMainScanner();
      statusFilter.addEventListener('change', loadHistory);
      exportBtn.addEventListener('click', exportCSV);
      soundBtn.addEventListener('click', toggleSound);
      noteScanCancel.addEventListener('click', cancelNoteScan);
    });

    async function startMainScanner() {
      try {
        currentScanner = new ZXing.BrowserMultiFormatReader();
        await currentScanner.decodeFromVideoDevice(
          undefined,
          'reader',
          (result, err) => {
            if (result) {
              const now = Date.now();
              const lastTime = lastScanTimeMap[result.text] || 0;
              if (now - lastTime >= 5000) { 
                lastScanTimeMap[result.text] = now; 
                addHistory(result.text);
                playBeep(); 
              } else {
                console.log("ä¸»æƒæï¼š5ç§’å…§é‡è¤‡æƒæï¼Œå·²ç•¥é", result.text);
              }
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error(err);
            }
          }
        );
      } catch (err) {
        console.error("æƒæå™¨åˆå§‹åŒ–å¤±æ•—:", err);
        alert("ç„¡æ³•å•Ÿå‹•æƒæå™¨: " + err.message);
      }
    }

    function addHistory(data) {
      const list = getHistoryList();
      const existingIndex = list.findIndex(item => item.data === data);
      const now = new Date().toISOString();
      if (existingIndex >= 0) {
        list[existingIndex].time = now;
      } else {
        list.unshift({
          data: data,
          time: now,
          status: "",
          notes: []
        });
      }
      saveHistoryList(list);
      loadHistory();
    }

    async function startNoteScan(time) {
      currentNoteTarget = time;
      noteScanModal.style.display = "flex";
      if (currentScanner) {
        currentScanner.reset();
        currentScanner = null;
      }
      try {
        currentScanner = new ZXing.BrowserMultiFormatReader();
        await currentScanner.decodeFromVideoDevice(
          undefined,
          'noteScanPreview', 
          (result, err) => {
            if (result) {
              const now = Date.now();
              const lastTime = lastScanTimeMap[result.text] || 0;
              if (now - lastTime >= 5000) { 
                lastScanTimeMap[result.text] = now; 
                playBeep(); 
                addNote(result.text); // ç›´æ¥æ·»åŠ å‚™è¨»ï¼Œä¸å½ˆå‡ºç¢ºèª
              } else {
                console.log("å‚™è¨»æƒæï¼š5ç§’å…§é‡è¤‡æƒæï¼Œå·²ç•¥é", result.text);
              }
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error(err);
            }
          }
        );
      } catch (err) {
        console.error("å‚™è¨»æƒæå¤±æ•—:", err);
        alert("å‚™è¨»æƒæéŒ¯èª¤: " + err.message);
        cancelNoteScan();
      }
    }

    function addNote(text) {
      const list = getHistoryList();
      const record = list.find(item => item.time === currentNoteTarget);
      if (record) { // æª¢æŸ¥è¨˜éŒ„æ˜¯å¦å­˜åœ¨
        if (!record.notes.includes(text)) { // æª¢æŸ¥å‚™è¨»æ˜¯å¦å·²å­˜åœ¨
          record.notes.push(text);
          saveHistoryList(list);
          // ç§»é™¤ alert("å·²æ·»åŠ å‚™è¨»: " + text);
        } else {
          // ç§»é™¤ alert("æ­¤å‚™è¨»å·²å­˜åœ¨æˆ–ç„¡æ•ˆ");
          console.log("å‚™è¨»å·²å­˜åœ¨æˆ–ç„¡æ•ˆï¼Œå·²ç•¥é:", text); // æ”¹ç‚ºæ§åˆ¶å°è¼¸å‡º
        }
      }
      cancelNoteScan(); 
      loadHistory();
    }

    function cancelNoteScan() {
      if (currentScanner) {
        currentScanner.reset();
        currentScanner = null;
      }
      noteScanModal.style.display = "none";
      currentNoteTarget = null;
      startMainScanner(); 
    }

    function handleStatusChange(time, status) {
      const list = getHistoryList();
      const record = list.find(item => item.time === time);
      if (record) {
        if (status === "delete") {
          if (confirm(`ç¢ºå®šåˆªé™¤è¨˜éŒ„: ${record.data}ï¼Ÿ`)) {
            list.splice(list.indexOf(record), 1);
          }
        } else {
          record.status = status;
        }
        saveHistoryList(list);
        loadHistory();
      }
    }

    function loadHistory() {
      const list = getHistoryList();
      const filter = statusFilter.value;
      const filtered = filter ? list.filter(item => item.status === filter) : list;
      const stats = {
        restock: list.filter(item => item.status === "restock").length,
        empty: list.filter(item => item.status === "empty").length,
        total: list.length
      };
      statusStats.innerHTML = `
        è£œè²¨: ${stats.restock} | 
        ç©ºä½: ${stats.empty} | 
        ç¸½æ•¸: ${stats.total}
      `;
      resultList.innerHTML = filtered.map(item => `
        <div class="record" data-time="${item.time}" data-status="${item.status}">
          <div>
            <strong>${item.data}</strong>
            <div class="time">${formatTime(item.time)}</div>
            ${item.notes.length > 0 ? `
              <div class="notes">
                ${item.notes.map(note => `ğŸ“„ ${note}`).join('<br>')}
              </div>
            ` : ''}
          </div>
          <div class="options">
            <button onclick="handleStatusChange('${item.time}', 'restock')" 
              ${item.status === 'restock' ? 'style="background:#ffa500;color:white"' : ''}>
              è£œè²¨
            </button>
            <button onclick="handleStatusChange('${item.time}', 'empty')" 
              ${item.status === 'empty' ? 'style="background:#b7f5b7;color:black"' : ''}>
              ç©ºä½
            </button>
            <button onclick="startNoteScan('${item.time}')"style="color:blue">å‚™è¨»</button>
            <button onclick="handleStatusChange('${item.time}', 'delete')" style="color:red">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }

    function initSound() {
      soundEnabled = localStorage.getItem(SOUND_KEY) === "true";
      updateSoundButton();
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem(SOUND_KEY, soundEnabled);
      updateSoundButton();
      if (soundEnabled) playBeep();
    }

    function updateSoundButton() {
      soundBtn.textContent = soundEnabled ? "ğŸ”Š éŸ³æ•ˆé–‹å•Ÿ" : "ğŸ”‡ éŸ³æ•ˆé—œé–‰";
      soundBtn.style.backgroundColor = soundEnabled ? "#d4edda" : "#f8d7da";
    }

    function playBeep() {
      if (!soundEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = "sine";
        osc.frequency.value = 880;
        osc.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
      } catch (err) {
        console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", err);
      }
    }

    function exportCSV() {
      const list = getHistoryList();
      if (list.length === 0) return alert("æ²’æœ‰å¯å°å‡ºçš„æ•¸æ“š");
      const headers = ["å…§å®¹", "æ™‚é–“", "ç‹€æ…‹", "å‚™è¨»"];
      const rows = list.map(item => [
        `"${item.data.replace(/"/g, '""')}"`,
        `"${formatTime(item.time)}"`,
        `"${getStatusText(item.status)}"`,
        `"${item.notes.join(" | ").replace(/"/g, '""')}"`
      ]);
      const csvContent = [
        headers.join(","),
        ...rows.map(row => row.join(","))
      ].join("\r\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `å±¤æ¶è¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function getHistoryList() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveHistoryList(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString();
    }

    function getStatusText(status) {
      const map = {
        restock: "è£œè²¨",
        empty: "ç©ºä½"
      };
      return map[status] || "";
    }

    window.handleStatusChange = handleStatusChange;
    window.startNoteScan = startNoteScan;
  </script>
</body>
</html>