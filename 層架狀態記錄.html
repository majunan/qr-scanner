<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±¤æ¶ç‹€æ…‹è¨˜éŒ„</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1, h2 { margin-top: 20px; }
    button { margin: 5px; padding: 6px 12px; font-size: 1em; cursor: pointer; }

    #reader { width: 300px; margin-bottom: 10px; }

    .record {
      border-left: 6px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 5px;
      display: flex;
      justify-content: space-between;
      background-color: #f9f9f9;
    }

    .record[data-status="restock"] { border-left-color: orange; }
    .record[data-status="move"]   { border-left-color: dodgerblue; }
    .record[data-status="empty"]  { border-left-color: red; }

    .highlight { background-color: #ffe680 !important; }
    .options label[data-status="restock"] { color: orange; }
    .options label[data-status="move"]    { color: dodgerblue; }
    .options label[data-status="empty"]   { color: red; }

    .left { flex: 1; }
    .time { font-size: 0.9em; color: gray; }

    #statusFilter { font-size: 1em; padding: 4px 8px; }
    #statusStats { margin-top: 10px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ å±¤æ¶ç‹€æ…‹è¨˜éŒ„</h1>
  <button id="enableSound">ğŸ”Š å•Ÿç”¨æç¤ºéŸ³</button>
  <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºå±¤æ¶ç‹€æ…‹</button>
  <div id="reader"></div>

  <h2>ğŸ“· å±¤æ¶æƒæ</h2>
  <select id="statusFilter">
    <option value="">å…¨éƒ¨</option>
    <option value="restock">è£œè²¨</option>
    <option value="move">ç§»ä½</option>
    <option value="empty">ç©ºä½</option>
  </select>

  <div id="statusStats"></div>
  <div id="resultList"></div>

  <script>
    const STORAGE_KEY = "qr-history";
    const resultList = document.getElementById("resultList");
    const statusFilter = document.getElementById("statusFilter");
    const statusStats = document.getElementById("statusStats");
    const exportBtn = document.getElementById("exportBtn");
    const enableSoundBtn = document.getElementById("enableSound");
    let beepSound = new Audio("https://cdn.jsdelivr.net/gh/darkthread/darkthread.github.io@master/demo/audio/beep.mp3"); // ä½¿ç”¨å¯ç›´æ¥è¨ªå•çš„éŸ³æ•ˆæª”
    let qrScanner = null;
    let highlightedElement = null;
    let lastScannedText = "";
    let lastScannedTime = 0;

    // å•Ÿç”¨è²éŸ³æŒ‰éˆ•
    enableSoundBtn.addEventListener("click", () => {
      beepSound.play().then(() => {
        beepSound.pause();
        beepSound.currentTime = 0;
        enableSoundBtn.style.display = "none";
        console.log("æç¤ºéŸ³å·²å•Ÿç”¨");
      }).catch(err => {
        alert("ç€è¦½å™¨ä¸å…è¨±è‡ªå‹•æ’­æ”¾éŸ³æ•ˆï¼Œè«‹å†æ¬¡é»æ“ŠæŒ‰éˆ•ä»¥å•Ÿç”¨ã€‚");
      });
    });

    exportBtn.onclick = exportCSV;
    statusFilter.onchange = loadHistory;

    function loadHistory() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const list = raw ? JSON.parse(raw) : [];
      const priority = { restock: 3, move: 2, empty: 1, "": 0 };
      list.sort((a, b) => {
        const pa = priority[a.status] || 0, pb = priority[b.status] || 0;
        if (pb !== pa) return pb - pa;
        return a.data.localeCompare(b.data);
      });

      const filtered = statusFilter.value ? list.filter(i => i.status === statusFilter.value) : list;
      resultList.innerHTML = filtered.map(item => `
        <div class="record" data-time="${item.time}" data-status="${item.status}">
          <div class="left">
            <div>${item.data}</div>
            <div class="time">${new Date(item.time).toLocaleString()}</div>
          </div>
          <div class="options">
            <label><input type="radio" name="opt-${item.time}" value="delete" onchange="handleOptionChange('${item.time}','delete')">åˆªé™¤</label>
            <label data-status="restock"><input type="radio" name="opt-${item.time}" value="restock" ${item.status === 'restock' ? 'checked' : ''} onchange="handleOptionChange('${item.time}','restock')">è£œè²¨</label>
            <label data-status="move"><input type="radio" name="opt-${item.time}" value="move" ${item.status === 'move' ? 'checked' : ''} onchange="handleOptionChange('${item.time}','move')">ç§»ä½</label>
            <label data-status="empty"><input type="radio" name="opt-${item.time}" value="empty" ${item.status === 'empty' ? 'checked' : ''} onchange="handleOptionChange('${item.time}','empty')">ç©ºä½</label>
          </div>
        </div>
      `).join("");

      const stats = { restock: 0, move: 0, empty: 0 };
      list.forEach(i => { if (stats.hasOwnProperty(i.status)) stats[i.status]++; });
      statusStats.innerHTML = `
        ğŸŸ§ è£œè²¨ï¼š${stats.restock} ç­†ã€€
        ğŸ”µ ç§»ä½ï¼š${stats.move} ç­†ã€€
        ğŸ”´ ç©ºä½ï¼š${stats.empty} ç­†ã€€
        âšª åˆè¨ˆï¼š${list.length} ç­†
      `;
    }

    function addHistory(data) {
      const time = new Date().toISOString();
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ data
      const existingItem = list.find(item => item.data === data);
      if (existingItem) {
          // å¦‚æœå·²å­˜åœ¨ï¼Œå‰‡æ›´æ–°æ™‚é–“ä¸¦å°‡å…¶ç§»åˆ°æœ€å‰é¢
          existingItem.time = time;
          // ç§»é™¤èˆŠé …ç›®
          const updatedList = list.filter(item => item.data !== data);
          // å°‡æ›´æ–°å¾Œçš„é …ç›®åŠ åˆ°æœ€å‰é¢
          updatedList.unshift(existingItem);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedList));
          loadHistory();
          highlightByTime(time);
      } else {
          // å¦‚æœä¸å­˜åœ¨ï¼Œå‰‡æ–°å¢
          list.unshift({ data, time, status: "" });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
          loadHistory();
          highlightByTime(time);
      }
    }
    
    function highlightByTime(time) {
        if (highlightedElement) highlightedElement.classList.remove("highlight");
        setTimeout(() => {
            const el = document.querySelector(`.record[data-time="${time}"]`);
            if (el) {
                el.classList.add("highlight");
                el.scrollIntoView({ behavior: "smooth", block: "center" });
                highlightedElement = el;
            }
        }, 100);
    }


    function handleOptionChange(time, action) {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const idx = list.findIndex(i => i.time === time);
      if (idx === -1) return;

      if (action === "delete") {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ [${list[idx].data}] é€™ç­†è¨˜éŒ„å—ï¼Ÿ`)) {
          loadHistory(); // å¦‚æœæŒ‰å–æ¶ˆï¼Œé‡æ–°è¼‰å…¥ä»¥é‚„åŸ radio button ç‹€æ…‹
          return;
        }
        list.splice(idx, 1);
      } else {
        list[idx].status = action;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      loadHistory();
    }

    function exportCSV() {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (!list.length) return alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºï¼");
      const header = ["æƒæå…§å®¹", "æ™‚é–“", "ç‹€æ…‹"];
      const csvRows = [header.join(",")];
      const statusName = s => s === 'restock' ? "è£œè²¨" : s === 'move' ? "ç§»ä½" : s === 'empty' ? "ç©ºä½" : "";

      list.forEach(i => {
        csvRows.push(`"${i.data.replace(/"/g,'""')}","${new Date(i.time).toLocaleString()}","${statusName(i.status)}"`);
      });
      
      const BOM = '\uFEFF'; // åŠ å…¥ BOMï¼Œè§£æ±º Excel é–‹å•Ÿ UTF-8 CSV äº‚ç¢¼å•é¡Œ
      const blob = new Blob([BOM + csvRows.join("\r\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `å±¤æ¶è¨˜éŒ„_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function startScanner() {
      if (qrScanner && qrScanner.isScanning) return;
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        decodedText => {
          const now = Date.now();
          // å¦‚æœæƒæåˆ°ç›¸åŒçš„æ–‡å­—ï¼Œä¸”é–“éš”å°æ–¼3ç§’ï¼Œå‰‡å¿½ç•¥
          if (decodedText === lastScannedText && now - lastScannedTime < 3000) {
            return;
          }
          lastScannedText = decodedText;
          lastScannedTime = now;
          addHistory(decodedText);
          
          if (enableSoundBtn.style.display === 'none') {
            beepSound.currentTime = 0;
            beepSound.play();
          }
        },
        errorMessage => {
          // å¿½ç•¥æƒæéŒ¯èª¤
        }
      ).catch(err => {
        console.error("ç„¡æ³•å•Ÿå‹•QRæƒæå™¨", err);
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªå·²æˆæ¬Šç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿçš„æ¬Šé™ã€‚");
      });
    }

    // åˆå§‹åŒ–
    loadHistory();
    startScanner();
  </script>
</body>
</html>