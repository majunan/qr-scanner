<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±¤æ¶ç‹€æ…‹è¨˜éŒ„</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-top: 30px; display: inline-block; margin-right: 10px; }
    #resultList { margin-top: 10px; }

    .record {
      border-left: 6px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
    }

    .record[data-status="restock"] { border-left-color: orange; }
    .record[data-status="move"]    { border-left-color: dodgerblue; }
    .record[data-status="empty"]   { border-left-color: red; }

    .highlight {
      background-color: #ffe680 !important;
    }

    .left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      max-width: 100%;
      flex: 1;
    }

    .time {
      font-size: 0.9em;
      color: gray;
    }

    .options {
      display: inline-flex;
      gap: 4px;
      white-space: nowrap;
    }

    .options label {
      margin-right: 0;
      font-size: 0.9em;
    }

    .options label[data-status="restock"] { color: orange; }
    .options label[data-status="move"]    { color: dodgerblue; }
    .options label[data-status="empty"]   { color: red; }

    button {
      margin: 5px 5px 15px 0;
      padding: 6px 12px;
      font-size: 1em;
      cursor: pointer;
    }

    #reader {
      width: 300px;
    }

    #statusFilter {
      font-size: 1em;
      padding: 4px 8px;
    }

    #statusStats {
      margin-top: 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ å±¤æ¶ç‹€æ…‹è¨˜éŒ„</h1>
  <button id="exportBtn">åŒ¯å‡ºå±¤æ¶ç‹€æ…‹æ˜ç´°è¡¨</button>
  <div id="reader"></div>

  <h2>ğŸ“· å±¤æ¶æƒæ</h2>
  <select id="statusFilter">
    <option value="">å…¨éƒ¨</option>
    <option value="restock">å¾…è£œè²¨</option>
    <option value="move">å¾…ç§»ä½</option>
    <option value="empty">ç©ºä½</option>
  </select>

  <div id="statusStats"></div>
  <div id="resultList"></div>

  <script>
    const STORAGE_KEY = "qr-history";
    const exportBtn = document.getElementById("exportBtn");
    const resultList = document.getElementById("resultList");
    const statusFilter = document.getElementById("statusFilter");
    const statusStats = document.getElementById("statusStats");
    let qrScanner = null;
    let lastScannedText = "";
    let lastScannedTime = 0;
    let highlightedElement = null;
    const beepSound = new Audio("beep.mp3");

    exportBtn.onclick = exportCSV;
    statusFilter.onchange = loadHistory;

    function loadHistory() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const list = raw ? JSON.parse(raw) : [];

      const priority = { restock: 3, move: 2, empty: 1, "": 0 };
      list.sort((a, b) => {
        const pa = priority[a.status || ""] || 0;
        const pb = priority[b.status || ""] || 0;
        if (pb !== pa) return pb - pa;
        return a.data.localeCompare(b.data);
      });

      const selectedStatus = statusFilter.value;
      const filtered = selectedStatus
        ? list.filter(item => item.status === selectedStatus)
        : list;

      resultList.innerHTML = filtered.map(item => `
        <div class="record" data-time="${item.time}" data-status="${item.status}">
          <div class="left">
            <div>${item.data}</div>
            <div class="time">${new Date(item.time).toLocaleString()}</div>
          </div>
          <div class="options">
            <label><input type="radio" name="option-${item.time}" value="delete" onchange="handleOptionChange('${item.time}', 'delete')">åˆªé™¤</label>
            <label data-status="restock"><input type="radio" name="option-${item.time}" value="restock" ${item.status === 'restock' ? 'checked' : ''} onchange="handleOptionChange('${item.time}', 'restock')">å¾…è£œè²¨</label>
            <label data-status="move"><input type="radio" name="option-${item.time}" value="move" ${item.status === 'move' ? 'checked' : ''} onchange="handleOptionChange('${item.time}', 'move')">å¾…ç§»ä½</label>
            <label data-status="empty"><input type="radio" name="option-${item.time}" value="empty" ${item.status === 'empty' ? 'checked' : ''} onchange="handleOptionChange('${item.time}', 'empty')">ç©ºä½</label>
          </div>
        </div>
      `).join('');

      // çµ±è¨ˆç‹€æ…‹æ•¸é‡
      const counts = { restock: 0, move: 0, empty: 0 };
      list.forEach(item => {
        if (item.status === "restock") counts.restock++;
        if (item.status === "move") counts.move++;
        if (item.status === "empty") counts.empty++;
      });
      const total = list.length;
      statusStats.innerHTML = `
        ğŸŸ§ å¾…è£œè²¨ï¼š${counts.restock} ç­†ã€€
        ğŸ”µ å¾…ç§»ä½ï¼š${counts.move} ç­†ã€€
        ğŸ”´ ç©ºä½ï¼š${counts.empty} ç­†ã€€
        âšª åˆè¨ˆï¼š${total} ç­†
      `;
    }

    function addHistory(data) {
      const time = new Date().toISOString();
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      list.push({ data, time, status: "" });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      loadHistory();

      if (highlightedElement) {
        highlightedElement.classList.remove("highlight");
      }

      setTimeout(() => {
        const latest = document.querySelector(`.record[data-time="${time}"]`);
        if (latest) {
          latest.classList.add("highlight");
          highlightedElement = latest;
          latest.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }, 100);
    }

    function removeHighlight() {
      if (highlightedElement) {
        highlightedElement.classList.remove("highlight");
        highlightedElement = null;
      }
    }

    function handleOptionChange(time, action) {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const idx = list.findIndex(item => item.time === time);
      if (idx === -1) return;

      if (action === "delete") {
        const confirmed = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æƒæç´€éŒ„å—ï¼Ÿ");
        if (!confirmed) {
          const radios = document.getElementsByName("option-" + time);
          radios.forEach(r => r.checked = false);
          return;
        }
        list.splice(idx, 1);
      } else {
        list[idx].status = action;
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      loadHistory();
      removeHighlight();
    }

    function exportCSV() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const list = raw ? JSON.parse(raw) : [];
      if (list.length === 0) {
        alert("æ²’æœ‰æƒæè¨˜éŒ„å¯åŒ¯å‡ºï¼");
        return;
      }

      const priority = { restock: 3, move: 2, empty: 1, "": 0 };
      list.sort((a, b) => {
        const pa = priority[a.status || ""] || 0;
        const pb = priority[b.status || ""] || 0;
        if (pb !== pa) return pb - pa;
        return a.data.localeCompare(b.data);
      });

      const header = ["æƒæå…§å®¹", "æ™‚é–“", "ç‹€æ…‹"];
      const csvRows = [header.join(",")];

      for (const item of list) {
        const data = `"${item.data.replace(/"/g, '""')}"`;
        const time = `"${new Date(item.time).toLocaleString()}"`;
        const statusName = item.status === 'restock' ? 'å¾…è£œè²¨' :
                           item.status === 'move' ? 'å¾…ç§»ä½' :
                           item.status === 'empty' ? 'ç©ºä½' : '';
        const status = `"${statusName}"`;
        csvRows.push([data, time, status].join(","));
      }

      const csvString = csvRows.join("\r\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;

      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const filename = `å®‰è£¹å±¤æ¶_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.csv`;

      a.download = filename;
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function startScanner() {
      if (qrScanner && qrScanner.isScanning) return;

      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decodedText => {
          const now = Date.now();
          if (decodedText === lastScannedText && now - lastScannedTime < 3000) return;
          lastScannedText = decodedText;
          lastScannedTime = now;

          removeHighlight();
          addHistory(decodedText);
          beepSound.play();
        },
        errorMessage => {
          console.error(errorMessage);
        }
      ).catch(err => {
        console.error("ç„¡æ³•å•Ÿå‹•æƒæå™¨:", err);
      });
    }

    // åˆå§‹åŒ–
    loadHistory();
    startScanner();
  </script>
</body>
</html>
